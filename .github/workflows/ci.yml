name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

jobs:
  # ──────────────────────────────────────────────
  # Job 1: Syntax check (fastest, fail early)
  # ──────────────────────────────────────────────
  lint:
    name: PHP Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      - name: Install dependencies
        run: composer install --no-progress --prefer-dist

      - name: PHP Parallel Lint
        run: composer lint

  # ──────────────────────────────────────────────
  # Job 2: Code style (PHPCS + WPCS)
  # ──────────────────────────────────────────────
  phpcs:
    name: PHPCS
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        php-version: ['8.0', '8.2']
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          tools: composer, cs2pr

      - name: Install dependencies
        run: composer install --no-progress --prefer-dist

      - name: Install WPCS
        run: |
          composer global require --dev \
            squizlabs/php_codesniffer \
            wp-coding-standards/wpcs \
            dealerdirect/phpcodesniffer-composer-installer

      - name: Run PHPCS
        run: composer global exec phpcs -- --standard=phpcs.xml --report=checkstyle | cs2pr

  # ──────────────────────────────────────────────
  # Job 3: Static analysis (PHPStan)
  # ──────────────────────────────────────────────
  phpstan:
    name: PHPStan
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      - name: Install dependencies
        run: composer install --no-progress --prefer-dist

      - name: Run PHPStan
        run: composer phpstan

  # ──────────────────────────────────────────────
  # Job 4: PHP compatibility check
  # ──────────────────────────────────────────────
  compat:
    name: PHP Compatibility
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      - name: Install PHPCompatibilityWP
        run: |
          composer global require --dev \
            phpcompatibility/phpcompatibility-wp:* \
            dealerdirect/phpcodesniffer-composer-installer

      - name: Check PHP 8.0+ compatibility
        run: |
          composer global exec phpcs -- \
            --standard=PHPCompatibilityWP \
            --runtime-set testVersion 8.0- \
            --ignore=*/vendor/*,*/node_modules/*,*/tests/* \
            .

  # ──────────────────────────────────────────────
  # Job 5: Unit tests
  # ──────────────────────────────────────────────
  test:
    name: PHPUnit
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      - name: Install dependencies
        run: composer install --no-progress --prefer-dist

      - name: Run tests
        run: composer test

  # ──────────────────────────────────────────────
  # Job 6: Security audit
  # ──────────────────────────────────────────────
  security:
    name: Security
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      - name: Install dependencies
        run: composer install --no-progress --prefer-dist

      - name: Composer audit
        run: composer audit

  # ──────────────────────────────────────────────
  # Job 7: Build & Release (only on tags)
  # ──────────────────────────────────────────────
  release:
    name: Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [phpcs, phpstan, compat, test, security]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer, wp-cli

      - name: Install dependencies
        run: composer install --no-progress --prefer-dist --no-dev

      - name: Install dist-archive
        run: wp package install wp-cli/dist-archive-command:@stable

      - name: Build archive
        run: wp dist-archive . --filename-format='{name}-{version}'

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: '*.zip'
          generate_release_notes: true
